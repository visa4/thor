
<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../element/file-upload/file-upload.html">
<link rel="import" href="../iconset/iconset.html">
<link rel="import" href="../../../../css/global-layout.html">
<link rel="import" href="../../../../css/global-styles.html">

<dom-module id="resource-view-upsert">
  <template>
    <style include="global-layout"></style>
    <style include="global-style"></style>
    <slot name="header"></slot>
    <div>
      <paper-input id="name" name="name" label="Name"></paper-input>
      <file-upload id="fileUpload" tmp-relative-path="/storage/tmp/" rename-single-file="resource"></file-upload>
    </div>
    <div>
      <div class="flex flex-horizontal-end" style="margin-top: 20px;">
        <paper-button on-tap="upsertResoruce">Add</paper-button>
      </div>
    </div>
  </template>

  <script>
    class ElementResourceViewUpsert extends Polymer.Element {

      static get is() { return 'resource-view-upsert'; }

      static get fs() { return require('fs') }

      static get path() { return require('path') }

      static get properties() {
          return {

              resource: {
                  type: Object,
                  notify: true,
                  value: {},
                  observer: '_resourceChanged'
              }
          }
      }


      _resourceChanged(newValue, oldValue) {
          this.$.name.value =  newValue.customName;
      }

      upsertResoruce() {

          if (!this.$.name.value) {
              return;
          }

          let data = {};
          let resourceStorage = serviceManager.get('StoragePluginManager').get(ResourceConfig.NAME_SERVICE)
          let file = this.$.fileUpload.files[0];
          let nameFile = this.$.name.value;

          if (this.resource.id) {

              data = resourceStorage.hydrator.extract(this.resource);
              data.customName = nameFile;

              if (file) {
                  data.size = file.size;
                  data.lastModified = file.lastModified;
                  data.location = file.location;
                  data.type = file.type;

                  if (file.dimension) {
                      data.dimension = file.dimension;
                  }

                  if (file.duration) {
                      data.duration = file.duration;
                  }

              }

          } else {
              if (file) {
                  data = resourceStorage.hydrator.extract(file);
              }
              data.customName = nameFile;
          }

          let method = this.resource.id ?  'update' : 'save';
          serviceManager.get('StoragePluginManager')
              .get(ResourceConfig.NAME_SERVICE)[method](data)
              .then((data) => {
                  serviceManager.get('PaperToastNotification').notify(method.charAt(0).toUpperCase() + method.slice(1) + ' resource');
              })
              .catch((err) => {
                      console.log(err)
                  }
              );
      }
    }

    window.customElements.define(ElementResourceViewUpsert.is, ElementResourceViewUpsert);

  </script>
</dom-module>
