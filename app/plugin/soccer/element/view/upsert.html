<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../../../../element/file-upload/file-upload.html">

<link rel="import" href="../../../../css/global-layout.html">
<link rel="import" href="../../../../css/global-styles.html">

<dom-module id="soccer-view-upsert">
    <template>
        <style>
            #cardSubSideline {
                padding: 8px;
            }

            .paper-sideline {
                padding: 8px;
            }

            .padding-left {
                margin-left: 30px;

            }

            .pd-r {
                padding-right: 6px;
            }

            #formResource {
                width:100%;
            }

            .paper-sideline paper-input,
            .paper-sub-monitor paper-input,
            .paper-sideline paper-autocomplete,
            .paper-sub-monitor paper-autocomplete {
                padding-left: 6px;
            }

            paper-dropdown-menu {
                width: 100%;
            }

        </style>
        <style include="global-layout"></style>
        <style include="global-style"></style>
        <slot name="header"></slot>
        <div class="flex flex-horizontal">
            <iron-form id="formResource">
                <form method="post">
                    <div style="display: flex; height: 400px;">
                        <div style="flex-basis: 50%; padding-right: 8px;">
                            <paper-autocomplete
                                    id="homeTeam"
                                    label="Squadra di casa"
                                    text-property="name"
                                    value-property="name"
                                    remote-source
                                    home
                                    on-autocomplete-selected="_selectTeam"
                                    on-autocomplete-change="_searchTeamChanged">
                                <template slot="autocomplete-custom-template">
                                    <style>
                                        :host {
                                            display: block;
                                        }

                                        paper-item.account-item {
                                            padding: 8px 16px;
                                        }

                                        .service-name {
                                            color: #333;
                                        }

                                        .service-description {
                                            margin-top: 4px;
                                            color: #999;
                                        }
                                    </style>
                                    <paper-item class="account-item" on-tap="_onSelect" role="option" aria-selected="false">
                                        <div>
                                            <div class="service-name">[[item.name]]</div>
                                        </div>
                                        <paper-ripple></paper-ripple>
                                    </paper-item>
                                </template>
                            </paper-autocomplete>
                        </div>
                        <div style="flex-basis: 50%;">
                            <paper-autocomplete
                                    id="guestTeam"
                                    label="Squadra ospite"
                                    text-property="name"
                                    value-property="name"
                                    remote-source
                                    guest
                                    on-autocomplete-selected="_selectTeam"
                                    on-autocomplete-change="_searchTeamChanged">
                                <template slot="autocomplete-custom-template">
                                    <style>
                                        :host {
                                            display: block;
                                        }

                                        paper-item.account-item {
                                            padding: 8px 16px;
                                        }

                                        .service-name {
                                            color: #333;
                                        }

                                        .service-description {
                                            margin-top: 4px;
                                            color: #999;
                                        }
                                    </style>
                                    <paper-item class="account-item" on-tap="_onSelect" role="option" aria-selected="false">
                                        <div>
                                            <div class="service-name">[[item.name]]</div>
                                        </div>
                                        <paper-ripple></paper-ripple>
                                    </paper-item>
                                </template>
                            </paper-autocomplete>
                        </div>
                    </div>

                    <div class="flex flex-horizontal-end">
                        <paper-button on-tap="submitResourceButton">Add</paper-button>
                    </div>
                </form>
            </iron-form>
        </div>
    </template>

    <script>
        class ElementSoccerViewUpsert extends Polymer.Element {

            static get is() {
                return 'soccer-view-upsert';
            }

            static get properties() {
                return {

                    resource: {
                        type: Object,
                        notify: true,
                        value: new Timer(),
           //             observer: '_resourceChanged'
                    },

                    labelAction: {
                        type: String,
                        value: 'Save'
                    }
                }
            }

            ready() {
                super.ready();
/*
                serviceManager.get('StoragePluginManager')
                    .get(SoccerConfig.NAME_SERVICE)
                    .eventManager.on(Storage.STORAGE_POST_SAVE, this._clearResource.bind(this)
                );

                this.$.formResource.addEventListener('iron-form-presubmit', this.submitResource.bind(this));
                */
            }

            /**
             *
             */
            submitResource(evt) {
                evt.preventDefault();

                console.log(this.resource);

                let method = this.resource.id ? 'update' : 'save';
                this.resource.type = this.$.type.selectedItem.getAttribute('value');

                serviceManager.get('StoragePluginManager')
                    .get(SoccerConfig.NAME_SERVICE)[method](this.resource)
                    .then((data) => {
                        serviceManager.get('PaperToastNotification').notify(method.charAt(0).toUpperCase() + method.slice(1) + ' timer');
                    })
                    .catch((err) => {
                            console.log(err)
                        }
                    );
            }

            /**
             * @param evt
             * @private
             */
            _searchTeamChanged(evt) {
                console.log('sssssssssssss', evt.detail.value);
                let listPath = "leagues/serie-a/seasons/18-19/teams";

                serviceManager.get('SoccerClient')
                    .get(listPath)
                    .then(res => res.json())
                    .then(json => {

                        console.log('Teams', json.data.teams);
                        let filter = json.data.teams.filter(
                            element => {
                                return element.name.search(new RegExp(evt.detail.value, 'i')) > -1;
                            }
                        );

                        evt.detail.target.suggestions(
                            filter
                        );
                    });
            }

            /**
             * @param evt
             * @private
             */
            _selectTeam(evt) {
                let isHomeTeam = evt.target.getAttribute('home') === '';
                let playersPath = `leagues/serie-a/seasons/18-19/teams/${evt.detail.option.team_slug}/players`;

                serviceManager.get('SoccerClient')
                    .get(playersPath)
                    .then(res => res.json())
                    .then(json => {

                        console.log('Players', isHomeTeam, evt.detail.option, json.data.players);
                        let pl = serviceManager.get('HydratorPluginManager').get('playerSoccerApiHydrator').hydrate(json.data.players[0])
                        console.log('Hydrator', pl);
                        console.log('extract', serviceManager.get('HydratorPluginManager').get('playerSoccerApiHydrator').extract(pl));
                        console.log('extract', serviceManager.get('HydratorPluginManager').get('playerSoccerHydrator').extract(pl));
                    });
            }


            /**
             * @param method
             * @returns {boolean}
             * @private
             */
            _isMethod(method) {
                let isMethod = false;
                switch (true) {
                    case method === 'update' && this.resource.id !== undefined:
                        isMethod = true;
                        break;
                    case method === 'save' && this.resource.id === undefined:
                        isMethod = true;
                        break;
                }

                return isMethod;
            }
        }

        window.customElements.define(ElementSoccerViewUpsert.is, ElementSoccerViewUpsert);

    </script>
</dom-module>
