<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../player-monitor/player-monitor.html">

<dom-module id="player-monitor-manager">
    <script>
        class ElementPlayerMonitorManager extends Polymer.Element {

            static get is() {
                return 'player-monitor-manager';
            }

            static get ipc() {
                return require('electron').ipcRenderer;
            }

            static get properties() {
                return {}
            }

            constructor() {
                super();
                ElementPlayerMonitorManager.ipc.on('player-monitor-config', this.configMonitor.bind(this));
                ElementPlayerMonitorManager.ipc.on('player-monitor-update', this.updateMonitors.bind(this));
            }

            /**
             * @param evt
             * @param msg
             */
            configMonitor(evt, msg) {
                this._appendRecursiveMonitor(document.body, msg);
            }

            /**
             * @param node
             * @param monitor
             * @private
             */
            _appendRecursiveMonitor(node, monitor) {

                let monitorElement = document.createElement("player-monitor");
                this._setStyleNode(monitorElement, monitor);

                Polymer.dom(this._getNodeToAppend(node)).appendChild(monitorElement);

                if (monitor.monitors && Array.isArray(monitor.monitors) && monitor.monitors.length > 0) {
                    for (let cont = 0; monitor.monitors.length > cont; cont++) {
                        this._appendRecursiveMonitor(monitorElement, monitor.monitors[cont]);
                    }
                }
            }

            _getNodeToAppend(node) {
                return node.root ? node.root.getElementById('monitors') : node;
            }

            /**
             * @param node
             * @param config
             * @private
             */
            _setStyleNode(node, config) {
                node.identifier = config.id;
                node.height = config.height;
                node.width = config.width;
                node.offsetX = config.offsetX;
                node.offsetY = config.offsetY;
                node.backgroundColor = config.backgroundColor;
            }


            updateMonitors(evt, msg) {
                let monitors = this._getMonitorsFromMessage(msg);
                let domMonitors = this._getMonitorsFromDom(document);

                let cont = 0;
                while (cont < monitors.length) {
                    let node = domMonitors.find( (element) => {
                        return monitors[cont].id === element.identifier;
                    });

                    let index = domMonitors.findIndex(node => node.identifier ===  monitors[cont].id);
                    if (index > -1) {
                        domMonitors.splice(index, 1);
                    }

                    if (node) {
                        this._setStyleNode(node, monitors[cont]);
                        monitors.splice(cont, 1);

                    } else {
                        cont++
                    }
                }

                for (let cont = 0; monitors.length > cont; cont++) {
                    let monitorElement = document.createElement("player-monitor");
                    this._setStyleNode(monitorElement,  monitors[cont]);
                    this._appendToParent(monitors[cont]._parent.id, monitorElement);
                }

                for (let cont = 0; domMonitors.length > cont; cont++) {
                    domMonitors[cont].remove();
                }
            }

            _appendToParent(id, element) {
                let domMonitors = this._getMonitorsFromDom(document);
                let domElement = domMonitors.find( (element) => {
                    return element.identifier === id;
                });

                if (domElement) {
                    Polymer.dom(this._getNodeToAppend(domElement)).appendChild(element);
                } else {
                    throw 'player-monitor parent not found';
                }
            }

            /**
             * @param msg
             * @param parent
             * @return []
             * @private
             */
            _getMonitorsFromMessage(msg, parent) {
                // TODO retrive from service manager and hydrator manager
                let hydrator = new PropertyHydrator(new Monitor());
                hydrator.enableHydrateProperty('id')
                    .enableHydrateProperty('brightness')
                    .enableHydrateProperty('offsetX')
                    .enableHydrateProperty('offsetY')
                    .enableHydrateProperty('width')
                    .enableHydrateProperty('height')
                    .enableHydrateProperty('backgroundColor');

                let monitor = hydrator.hydrate(msg);
                let monitors = [];

                if (msg.monitors && Array.isArray(msg.monitors) && msg.monitors.length > 0) {
                    for (let cont = 0; msg.monitors.length > cont; cont ++) {
                        monitors = monitors.concat(this._getMonitorsFromMessage(msg.monitors[cont], monitor));
                    }
                    return monitors.concat([monitor]);
                } else {
                    if (parent) {
                        monitor._parent = parent;
                    }
                    return [monitor];
                }
            }

            _getMonitorsFromDom(node) {

                let nodeList = [];
                let monitors = [];

                if (node.nodeName === 'playerMonitor') {
                    monitors.push(node);
                }

                if (node.root) {
                    nodeList = node.root.querySelectorAll('player-monitor');
                } else {
                    nodeList = node.querySelectorAll('player-monitor');
                }

                if (nodeList.length === 0) {
                    return monitors;
                } else {
                    for (let cont = 0; nodeList.length > cont; cont++) {
                        monitors = monitors.concat(this._getMonitorsFromDom(nodeList[cont]));
                    }
                    return monitors;
                }
            }
        }

        window.customElements.define(ElementPlayerMonitorManager.is, ElementPlayerMonitorManager);

    </script>
</dom-module>