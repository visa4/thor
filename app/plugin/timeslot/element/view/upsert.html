
<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../../../element/file-upload/file-upload.html">


<link rel="import" href="../../../../css/global-layout.html">
<link rel="import" href="../../../../css/global-styles.html">

<dom-module id="timeslot-view-upsert">
  <template>
    <style include="global-layout"></style>
    <style include="global-style"></style>
    <style>
      paper-dropdown-menu {
        width: 100%;
      }

      paper-listbox {
        min-width: 400px;
      }
    </style>
    <slot name="header"></slot>
    <div>
      <paper-input id="name" name="name" label="Name"></paper-input>
      <paper-input id="duration" name="duration" label="Duration" type="number" min="1"></paper-input>
      <paper-dropdown-menu id="monitor" label="Monitor">
        <paper-listbox id="monitors" slot="dropdown-content">
          <template is="dom-repeat" items="{{monitors}}" as="monitorWrapper">
            <paper-item item="{{monitorWrapper}}">{{monitorWrapper.monitor.name}} - {{monitorWrapper.config.name}}</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <paper-dropdown-menu id="resource" label="Resource">
        <paper-listbox id="resources" slot="dropdown-content" multi>
          <template is="dom-repeat" items="{{resources}}" as="resource">
            <paper-item item="{{resource}}">{{resource.customName}}</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
    </div>
    <div>
      <div class="flex flex-horizontal-end" style="margin-top: 20px;">
        <paper-button on-tap="upsertTimeslot">{{labelAction}}</paper-button>
      </div>
    </div>
  </template>

  <script>
      class ElementTimeslotViewUpsert extends Polymer.Element {

          static get is() { return 'timeslot-view-upsert'; }

          static get fs() { return require('fs') }

          static get path() { return require('path') }

          static get properties() {
              return {

                  timeslot: {
                      type: Object,
                      notify: true,
                      value: {},
                      observer: '_timeslotChanged'
                  },

                  monitors: {
                      type: Array,
                      notify: true,
                      value: [],
                      observer: '_monitorsChanged'
                  },

                  resources: {
                      type: Array,
                      value: []
                  },

                  labelAction: {
                      type: String,
                      value: 'Save'
                  }
              }
          }

          ready() {
              super.ready();
              serviceManager.get('StoragePluginManager')
                  .get(TimeslotConfig.NAME_SERVICE)
                  .eventManager.on(Storage.STORAGE_POST_SAVE, this._clearData.bind(this)
              );
          }

          _clearData() {
              this.$.name.value = null;
              this.$.duration.value = null;

              this.timeslot.resources = []; // TODO REMOVE AND CONTROLL
          }

          connectedCallback () {
              super.connectedCallback();
              let virtualMonitors = [];
              let monitors =  [];

              serviceManager.get('StoragePluginManager')
                  .get(MonitorConfig.NAME_SERVICE)
                  .getAll()
                  .then((data) =>  {
                      virtualMonitors = data;

                      for (let cont = 0; virtualMonitors.length > cont; cont++) {
                          let internaMonitor =  virtualMonitors[cont].getMonitors({nested:true});
                          for (let index = 0; internaMonitor.length > index; index++) {
                              monitors.push({
                                  monitor : internaMonitor[index],
                                  config : virtualMonitors[cont]
                              });
                          }
                      }
                      this.monitors = monitors;
                  });
          }

          _monitorsChanged(newValue, oldValue) {

              if (!newValue || newValue.length === 0) {
                  return;
              }

              serviceManager.get('StoragePluginManager')
                  .get(ResourceConfig.NAME_SERVICE)
                  .getAll()
                  .then((data) => {
                      this.resources = data;
                  })
                  .catch((err) => {
                          console.log(err)
                      }
                  );
          }

          _timeslotChanged(newValue, oldValue) {


              if (newValue.name) {
                  this.$.name.value = newValue.name;
              }

              if (newValue.duration) {
                  this.$.duration.value = newValue.duration;
              }

              for (let cont = 0; this.$.monitors.items.length > cont; cont++) {

                  if (newValue.virtualMonitorReference
                      && this.$.monitors.items[cont].item.monitor.id === newValue.virtualMonitorReference.monitorId) {
                      this.$.monitors.selected = cont;
                      break;
                  }
              }


              if (!newValue.resources || newValue.resources.length === 0) {
                  return;
              }

              let multiselect = [];
              for (let cont = 0; newValue.resources.length > cont; cont++) {

                  let index =  this.$.resources.items.findIndex(
                      (paperItem) => {
                          return newValue.resources[cont].id  === paperItem.item.id
                      }
                  )
                  multiselect.push(index);
              }

              this.labelAction = newValue && newValue.id ? 'Update' :  'Save';
              this.$.resources.selectedValues = multiselect;
          }

          upsertTimeslot() {

              // TODO VALIDATION
              if (!this.$.name || !this.$.duration || !this.$.resource.value || !this.$.monitor.value) {
                  return;
              }

              let timeslot = new Timeslot();
              let method = 'save';

              if (this.timeslot.id) {
                  method = 'update';
              } else {
                  timeslot.id = Utils.uid;
                  this.timeslot = timeslot;
              }

              this.timeslot.name = this.$.name.value;
              this.timeslot.duration = this.$.duration.value;

              // TODO from hydrator
              let ref = new VirtualMonitorReference();
              ref.virtualMonitorId = this.$.monitor.selectedItem.item.config.id;
              ref.monitorId = this.$.monitor.selectedItem.item.monitor.id;
              ref.name = this.$.monitor.selectedItem.item.monitor.name;
              this.timeslot.virtualMonitorReference = ref;

              this.timeslot.resources = []; // TODO REMOVE AND CONTROLL
              this.$.resources.selectedItems.forEach(
                  (paperItem) => {this.timeslot.resources.push(paperItem.item)}
              );

              serviceManager.get('StoragePluginManager')
                  .get(TimeslotConfig.NAME_SERVICE)[method](this.timeslot)
                  .then((data) => {
                      serviceManager.get('PaperToastNotification').notify(method.charAt(0).toUpperCase() + method.slice(1) + ' timeslot');
                  })
                  .catch((err) => {
                          console.log(err)
                      }
                  );

          }
      }

      window.customElements.define(ElementTimeslotViewUpsert.is, ElementTimeslotViewUpsert);

  </script>
</dom-module>
