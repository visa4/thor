
<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../../../element/file-upload/file-upload.html">


<link rel="import" href="../../../../css/global-layout.html">
<link rel="import" href="../../../../css/global-styles.html">
<link rel="import" href="../data-injector-input/data-injector-input.html">

<dom-module id="timeslot-view-upsert">
  <template>
    <style include="global-layout"></style>
    <style include="global-style"></style>
    <style>
      paper-dropdown-menu {
        width: 100%;
      }
    </style>
    <slot name="header"></slot>
    <div>
      <paper-input id="name" name="name" label="Name"></paper-input>
      <paper-input id="duration" name="duration" label="Duration" type="number" min="1"></paper-input>
      <paper-dropdown-menu id="monitor" label="Monitor">
        <paper-listbox id="monitors" slot="dropdown-content">
          <template is="dom-repeat" items="{{monitors}}" as="monitorWrapper">
            <paper-item item="{{monitorWrapper}}">{{monitorWrapper.monitor.name}} - {{monitorWrapper.config.name}}</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <paper-dropdown-menu id="resource" label="Resource">
        <paper-listbox id="resources" slot="dropdown-content" multi>
          <template is="dom-repeat" items="{{resources}}" as="resource">
            <paper-item item="{{resource}}">{{resource.customName}}</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
    </div>
    <paper-dropdown-menu id="bind" label="Bind timeslot">
      <paper-listbox id="binds" slot="dropdown-content" multi>
        <template is="dom-repeat" items="{{binds}}" as="bind">
          <paper-item item="{{bind}}">{{bind.name}}</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>
    </div>
    <data-injector-input id="dataRefernces"></data-injector-input>
    <div>
      <div class="flex flex-horizontal-end" style="margin-top: 20px;">
        <paper-button on-tap="upsertTimeslot">{{labelAction}}</paper-button>
      </div>
    </div>

  </template>

  <script>
      class ElementTimeslotViewUpsert extends Polymer.Element {

          static get is() { return 'timeslot-view-upsert'; }

          static get fs() { return require('fs') }

          static get path() { return require('path') }

          static get properties() {
              return {

                  timeslot: {
                      type: Object,
                      notify: true,
                      value: new Timeslot(),
                      observer: '_timeslotChanged'
                  },

                  monitors: {
                      type: Array,
                      notify: true,
                      value: [],
                      observer: '_monitorsChanged'
                  },

                  resources: {
                      type: Array,
                      value: []
                  },

                  labelAction: {
                      type: String,
                      value: 'Save'
                  },

                  binds: {
                      type: Array,
                      value: []
                  }
              }
          }

          ready() {
              super.ready();
              serviceManager.get('StoragePluginManager')
                  .get(TimeslotConfig.NAME_SERVICE)
                  .eventManager.on(Storage.STORAGE_POST_SAVE, this._clearData.bind(this)
              );

              serviceManager.get('StoragePluginManager')
                  .get(TimeslotConfig.NAME_SERVICE)
                  .getAll(1, 100)
                  .then((data) =>  {
                     this.binds = data;
                  });
          }

          _clearData() {
              this.$.name.value = null;
              this.$.duration.value = null;
              this.timeslot = new Timeslot();
          }

          connectedCallback () {
              super.connectedCallback();
              let virtualMonitors = [];
              let monitors =  [];

              serviceManager.get('StoragePluginManager')
                  .get(MonitorConfig.NAME_SERVICE)
                  .getAll()
                  .then((data) =>  {
                      virtualMonitors = data;

                      for (let cont = 0; virtualMonitors.length > cont; cont++) {
                          let internaMonitor =  virtualMonitors[cont].getMonitors({nested:true});
                          for (let index = 0; internaMonitor.length > index; index++) {
                              monitors.push({
                                  monitor : internaMonitor[index],
                                  config : virtualMonitors[cont]
                              });
                          }
                      }
                      this.monitors = monitors;
                  });
          }

          _monitorsChanged(newValue, oldValue) {

              if (!newValue || newValue.length === 0) {
                  return;
              }

              serviceManager.get('StoragePluginManager')
                  .get(ResourceConfig.NAME_SERVICE)
                  .getAll(1, 100)
                  .then((data) => {
                      this.resources = data;
                  })
                  .catch((err) => {
                          console.log(err)
                      }
                  );
          }

          _timeslotChanged(newValue, oldValue) {


              if (newValue.name) {
                  this.$.name.value = newValue.name;
              }

              if (newValue.duration) {
                  this.$.duration.value = newValue.duration;
              }

              for (let cont = 0; this.$.monitors.items.length > cont; cont++) {

                  if (newValue.virtualMonitorReference
                      && this.$.monitors.items[cont].item.monitor.id === newValue.virtualMonitorReference.monitorId) {
                      this.$.monitors.selected = cont;
                      break;
                  }
              }


              if (!newValue.resources || newValue.resources.length === 0) {
                  return;
              }

              let multiselect = [];
              for (let cont = 0; newValue.resources.length > cont; cont++) {

                  let index =  this.$.resources.items.findIndex(
                      (paperItem) => {
                          return newValue.resources[cont].id  === paperItem.item.id
                      }
                  )
                  multiselect.push(index);
              }
              this.$.resources.selectedValues = multiselect;

              multiselect = [];
              for (let cont = 0; newValue.binds.length > cont; cont++) {

                  let index =  this.$.binds.items.findIndex(
                      (paperItem) => {
                          return newValue.binds[cont].id  === paperItem.item.id
                      }
                  );
                  multiselect.push(index);
              }
              this.$.binds.selectedValues = multiselect;

              if (Array.isArray(this.timeslot.dataReferences) && this.timeslot.dataReferences.length > 0) {
                  let dataReferences = this.timeslot.dataReferences[0];

                  let index = this.$.dataRefernces.$.serviceInput.source.findIndex(
                      (element) => {
                          return element.serviceName == dataReferences.name;
                      }
                  );

                  if (index > -1) {
                      this.$.dataRefernces.service = this.$.dataRefernces.$.serviceInput.source[index];
                      this.$.dataRefernces.$.serviceInput.text =  this.$.dataRefernces.service.serviceLabel;
                      this.$.dataRefernces.hideDataInput = false;

                      this.$.dataRefernces.data = this.$.dataRefernces.service.getTimeslotData(dataReferences.data);
                      console.log('jjjjjjjjjj',  this.$.dataRefernces.data);
                      this.$.dataRefernces.$.dataInput.text = this.$.dataRefernces.data.name;
                  }
              }




              this.labelAction = newValue && newValue.id ? 'Update' :  'Save';
          }

          upsertTimeslot() {

              // TODO VALIDATION
              if (!this.$.name || !this.$.duration || !this.$.resource.value || !this.$.monitor.value) {
                  return;
              }


              let method = 'save';

              if (this.timeslot.id) {
                  method = 'update';
              } else {
                  this.timeslot.id = Utils.uid;
              }

              this.timeslot.name = this.$.name.value;
              this.timeslot.duration = this.$.duration.value;

              // TODO from hydrator
              let ref = new VirtualMonitorReference();
              ref.virtualMonitorId = this.$.monitor.selectedItem.item.config.id;
              ref.monitorId = this.$.monitor.selectedItem.item.monitor.id;
              ref.name = this.$.monitor.selectedItem.item.monitor.name;
              this.timeslot.virtualMonitorReference = ref;

              let resources = [];
              this.$.resources.selectedItems.forEach(
                  (paperItem) => {resources.push(paperItem.item)}
              );
              this.timeslot.resources = resources;

              let binds = [];
              this.$.binds.selectedItems.forEach(
                  (paperItem) => {binds.push(paperItem.item)}
              );
              this.timeslot.binds = binds;

              this.timeslot.dataReferences = [];
              if (this.$.dataRefernces.data && this.$.dataRefernces.service) {
                  let timeslotData = new TimeslotDataReference();
                  timeslotData.name = this.$.dataRefernces.service.serviceName;
                  timeslotData.data  = this.$.dataRefernces.service.extractTimeslot(this.$.dataRefernces.data);
                  this.timeslot.dataReferences.push(timeslotData);
              }


              serviceManager.get('StoragePluginManager')
                  .get(TimeslotConfig.NAME_SERVICE)[method](this.timeslot)
                  .then((data) => {
                      serviceManager.get('PaperToastNotification').notify(method.charAt(0).toUpperCase() + method.slice(1) + ' timeslot');
                  })
                  .catch((err) => {
                          console.log(err)
                      }
                  );
          }
      }

      window.customElements.define(ElementTimeslotViewUpsert.is, ElementTimeslotViewUpsert);

  </script>
</dom-module>
