
<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="thor-form">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <!-- This form is used to collect the elements that should be submitted -->
        <slot></slot>

        <form id="helper" action$="[[action]]" method$="[[method]]" enctype$="[[enctype]]"></form>
    </template>

    <script>
        class ThorForm extends Polymer.Element {

            static get baseTypeAllowed() {
                return [
                    'paper-input',
                    'input',
                    'select',
                ];
            }

            static get is() { return 'thor-form'; }

            static get regexPattern() { return /(\[[\w-]*\])/g; }

            static get properties() {
                return {
                    typeAllowed: {
                        type: Array,
                        value : []
                    }
                }
            }

            ready() {
                super.ready();
                this.__typeAllowed = ThorForm.baseTypeAllowed.concat(this.typeAllowed);
                let element = Polymer.dom(this).querySelector('[submitable]');
                if (element) {
                    element.addEventListener('click', this.submit.bind(this));
                }

                element = Polymer.dom(this).querySelector('[resetable]');
                if (element) {
                    element.addEventListener('click', this.reset.bind(this));
                }
            }

            connectedCallback() {
                super.connectedCallback();
            }

            /**
             * @param parent
             * @param ignoreName
             * @returns {Array}
             * @private
             */
            _findElements(parent, ignoreName) {
                let nodes = Polymer.dom(parent).querySelectorAll('*');

                let submittable = [];
                for (let i = 0; i < nodes.length; i++) {
                    switch (true) {
                        case nodes[i].root && this.__typeAllowed.indexOf(nodes[i].tagName.toLowerCase()) < 0:
                            Array.prototype.push.apply(submittable, this._findElements(nodes[i].root, ignoreName));
                            continue;
                            break;
                        case this.__typeAllowed.indexOf(nodes[i].tagName.toLowerCase()) < 0:
                        case nodes[i].disabled:
                            continue;
                            break;
                    }

                    submittable.push(nodes[i]);
                }
                return submittable;
            }

            _serializeElementValues(element) {

                let value = null;
                let tagName = element.tagName.toLowerCase();

                switch (tagName) {
                    case 'select':
                        value = [];
                        for (let i = 0; i < element.options.length; i++) {
                            if (element.options[i].selected) {
                                value.push(element.options[i].value)
                            }
                        }
                        break;
                    default:
                        value = (element.value === undefined) ? null : element.value;
                        break;

                }

                return value;
            }

            _patternMatches(str) {

                let entryString = str;
                let matches = [];

                let regEx = ThorForm.regexPattern;
                let findExpr;
                while ((findExpr = regEx.exec(entryString)) !== null) {
                     matches.push(findExpr[0]);
                }

                for (let i = 0; matches.length > i; i++) {
                    entryString = entryString.replace(matches[i], '');
                }

                matches.unshift(entryString);
                return matches;
            }

            _insertValueData(data, arrayName, value) {

                if (arrayName.length === 1) {
                    data[arrayName[0]] = value;
                }



            }

            getData() {
                let elements = this._findElements(this);
                let data = {};


                for (let i = 0; i < elements.length; i++) {
                    this._insertValueData(
                        data,
                        this._patternMatches(elements[i].name),
                        this._serializeElementValues(elements[i])
                    );
                }
            }

            submit(event) {
                if (event) {
                    event.preventDefault();
                }

                let data = this.getData();
                // TODO validationth
                this.fire('thor-form-data', data);
            }

            reset(event) {
                let elements = this._findElements(this);
                for (let i = 0; i < elements.length; i++) {

                    elements[i].value = null;
                    elements[i].checked = false;
                }
            }
        }

        window.customElements.define(ThorForm.is, ThorForm);

    </script>
</dom-module>