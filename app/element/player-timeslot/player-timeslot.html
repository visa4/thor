
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="player-timeslot">
    <template>
        <style>
            #resources {
                display: block;
                height: 100%;
                width: 100%;
                position: relative;
            }

            .resource {
                position: absolute;
                height: 100%;
                width: 100%;
                top:0;
                left: 0;
            }

            div.image {
                height: 100%;
                width: 100%;
                background-position: center;
                background-repeat: no-repeat;
                background-size: cover;
            }

            video {
                height: 100%;
                width: 100%;
                object-fit: fill;
            }

        </style>
        <div id="resources">

        </div>

    </template>

    <script>
        class ElementPlayerTimeslot extends Polymer.Element {

            static get is() { return 'player-timeslot'; }

            static get properties() {
                return {
                    timeslot: {
                        type: Object
                    },

                    timeslotId: {
                        type: String,
                        reflectToAttribute: true,
                    },

                    height: {
                        type: Number,
                        notify : true
                    },

                    width: {
                        type: Number,
                        notify : true
                    },

                    /**
                     * For debug
                     */
                    _timeInterval: {
                        type: Number,
                        value : 0
                    }
                }
            }

            config(timeslot, options) {
                this.timeslot = timeslot;
                this.timeslotId = timeslot.id;
                this.timeslotOptions = options;
            }

            /**
             *
             */
            hasTimeslotOptions(name) {
                return !!this.timeslotOptions && typeof this.timeslotOptions === 'object' && this.timeslotOptions[name];
            }

            /**
             * Event when append element
             */
            connectedCallback() {
                super.connectedCallback();

                if (!this.hasTimeslotOptions('loop') || (this._hasResourceType('video') && this.hasTimeslotOptions('loop'))) {
                    setTimeout(this._timeout.bind(this), this.timeslot.duration * 1000);
                    this._handlarInterval = setInterval(this._intervalDebug.bind(this), 1000);
                }

                for (let cont = 0; this.timeslot.resources.length > cont; cont++) {

                    let divResource = this._createResourceDiv();
                    switch ( this.timeslot.resources[cont].type) {
                        case 'image/jpeg':
                        case 'image/png':

                            let divImage = this._creteImage(this.timeslot.resources[cont]);
                            divResource.appendChild(divImage);
                            this.$.resources.appendChild(divResource);
                            break;
                        case 'video/mp4':
                            let tagVideo = this._createVideo(this.timeslot.resources[cont]);
                            divResource.appendChild(tagVideo);
                            this.$.resources.appendChild(divResource);
                            break;
                        case 'text/html':
                            this._createWebComponent(this.timeslot.resources[cont])
                                .then(
                                    function(data) {
                                        this.$.resources.appendChild(data);
                                    }.bind(this)
                                )
                                .catch(
                                    function(data) {
                                        console.warn(data);
                                    }
                                );
                            break;
                        default:
                            // TODO log error
                            console.error('Resource type not found', this.timeslot.resource[cont]);
                    }
                }
            }

            /**
             * Create div resource that wrap resource
             *
             * @private
             * @return Element
             */
            _createResourceDiv() {
                let element = document.createElement('div');
                element.classList.add("resource");
                return element;
            }

            /**
             * TODO remove when add autoload services in player, this.timeslot will be a Timeslot object
             */
            _hasResourceType(type)  {
                return !!this.timeslot.resources.find((resource) => {
                    return resource.type.indexOf(type) > -1;
                });
            }

            /**
             * Create image tag
             *
             * @private
             * @param resource
             * @return Element
             */
            _creteImage(resource) {

                let element = document.createElement('div');

                element.classList.add("image");
                element.style.backgroundImage = `url('${resource.location.path}${resource.location.name}')`;
                return element;
            }

            /**
             * Create video tag
             *
             * @private
             * @param resource
             * @return Element
             */
            _createVideo(resource) {

                let element = document.createElement('video');
                element.src = `${resource.location.path}${resource.location.name}`;
                element.autoplay = true;
                element.loop = this.hasTimeslotOptions('loop');

                if (!element.loop) {
                    let isRunning = true;
                    element.addEventListener('timeupdate', function() {
                        if ((this.currentTime + 0.5) >= this.duration && isRunning) {
                            this.pause();
                            isRunning = false;
                        }
                    }, false);
                }

                return element;
            }

            /**
             * Create webview
             *
             * @private
             * @param resource
             * @return Element
             */
            _createWebComponent(resource) {
                let fs = require('fs');
                let promise = new Promise((resolve, reject) => {
                    let entryPoint = `${resource.location.path}${resource.location.name}`;
                    if (fs.existsSync(entryPoint)) {

                        if (!customElements.get(resource.wcName)) {

                            Polymer.importHref(
                                entryPoint,
                                () => {
                                    resolve(document.createElement(resource.wcName)); }
                            );
                        } else {
                            resolve(
                                document.createElement(resource.wcName)
                            );
                        }

                    } else {
                        console.warn(`Web component entry point not found: ${entryPoint}`);
                        reject(`Web component entry point not found: ${entryPoint}`);

                    }
                });
                return promise;
            }

            disconnectedCallback() {
                super.disconnectedCallback();
                if (this._handlarInterval) {
                    window.clearInterval(this._handlarInterval);
                }
            }

            /**
             * @private
             */
            _timeout() {
                switch (true) {
                    case !this.hasTimeslotOptions('loop'):
                        this.remove();
                        break;
                    case this._hasResourceType('video'):
                        let videos = this.shadowRoot.querySelectorAll('video');
                        for (let cont = 0; videos.length > cont; cont++) {
                            videos[cont].currentTime = 0;
                            setTimeout(this._timeout.bind(this), this.timeslot.duration * 1000);
                        }
                        break;
                }
            }

            /**
             * For debug
             *
             * @private
             */
            _intervalDebug() {
                this._timeInterval = this._timeInterval == this.timeslot.duration ? 1 : this._timeInterval + 1;
                console.log('interval', this._timeInterval, this);
            }
        }

        window.customElements.define(ElementPlayerTimeslot.is, ElementPlayerTimeslot);

    </script>
</dom-module>

